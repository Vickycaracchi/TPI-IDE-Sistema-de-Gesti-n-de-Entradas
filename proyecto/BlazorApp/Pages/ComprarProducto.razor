@page "/comprar-producto"
@using DTOs
@using API.Clients
@using System.Linq
@inject NavigationManager Navigation
@inject LoginState LoginState

<Header />
<br />
<br />
<br />
<br />

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Comprar Producto</h3>
        </div>

        <div class="card-body">

            @if (loading)
            {
                <div class="d-flex justify-content-center my-4">
                    <div class="spinner-border text-primary"></div>
                </div>
            }
            else
            {
                @if (!string.IsNullOrEmpty(alertMessage))
                {
                    <div class="alert @alertCss">@alertMessage</div>
                }

                <div class="row">
                    <div class="col-md-5 mb-4">
                        <h5 class="text-primary mb-3">Compras</h5>

                        @if (comprasParaMostrar?.Any() != true)
                        {
                            <div class="text-muted fst-italic">No hay compras disponibles.</div>
                        }
                        else
                        {
                            <table class="table table-sm table-hover shadow-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th></th>
                                        <th>Vendedor</th>
                                        <th>Evento</th>
                                        <th>Lugar</th>
                                        <th>FechaHora</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in comprasParaMostrar)
                                    {
                                        var isSelected = selectedCompraKey != null &&
                                        selectedCompraKey.IdCliente == item.CompraKey.IdCliente &&
                                        selectedCompraKey.IdFiesta == item.CompraKey.IdFiesta &&
                                        selectedCompraKey.FechaHora == item.CompraKey.FechaHora;

                                        <tr class="@(isSelected ? "table-primary" : "")"
                                            style="cursor:pointer"
                                            @onclick="() => SelectCompra(item.CompraKey)">
                                            <td>
                                                <input type="radio" name="compraSelect" checked="@(isSelected)" />
                                            </td>
                                            <td>@item.Vendedor</td>
                                            <td>@item.Evento</td>
                                            <td>@item.Lugar</td>
                                            <td>@item.FechaHora.ToString("g")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>

                    <div class="col-md-7">
                        <h5 class="text-primary mb-3">Productos</h5>

                        @if (productosParaMostrar?.Any() != true)
                        {
                            <div class="text-muted fst-italic">No hay productos.</div>
                        }
                        else
                        {
                            <table class="table table-sm shadow-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Id</th>
                                        <th>Descripción</th>
                                        <th>Precio</th>
                                        <th style="width:120px">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var p in productosParaMostrar)
                                    {
                                        <tr>
                                            <td>@p.Id</td>
                                            <td>@p.Descripcion</td>
                                            <td>@p.Precio</td>
                                            <td>
                                                <input class="form-control form-control-sm" type="number" min="0" value="@p.Cantidad"
                                                       @onchange="(e) => OnCantidadChanged(p, e.Value?.ToString())" />
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }

                        <div class="mt-3 text-end">
                            <button class="btn btn-primary me-2" @onclick="ComprarAsync" disabled="@isProcessing">
                                Comprar
                            </button>
                            <button class="btn btn-secondary" @onclick="Volver">
                                Volver
                            </button>
                        </div>
                    </div>
                </div>
            }

        </div>
    </div>
</div>
<Footer />

@code {
    [Parameter]
    public UsuarioDTO UsuarioIngresado { get; set; }

    private bool loading = true;
    private bool isProcessing = false;
    private string alertMessage;
    private string alertCss = "alert-danger";

    private List<CompraListItem> comprasParaMostrar = new();
    private CompraKeyDTO selectedCompraKey;
    private List<ProdcutoConCantidadDTO> productosParaMostrar = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAllAsync();
    }

    private async Task LoadAllAsync()
    {
        loading = true;
        alertMessage = null;
        try
        {
            var usuario = LoginState.Usuario;

            if (usuario == null)
            {
                LoginState.MensajeTemporal = "Debe iniciar sesión para acceder al listado de compras";
                Navigation.NavigateTo("/login");
                return;
            }

            int id = usuario.Id;
            // Cargar compras y referencias
            var compras = await CompraApiClient.GetAllCliAsync(id);
            var usuarios = await UsuarioApiClient.GetAllAsync();
            var fiestas = await FiestaApiClient.GetAllAsync();
            var lugares = await LugarApiClient.GetAllAsync();
            var eventos = await EventoApiClient.GetAllAsync();

            comprasParaMostrar = compras.Select(c =>
            {
                var vendedor = usuarios.FirstOrDefault(u => u.Id == c.IdVendedor);
                var fiesta = fiestas.FirstOrDefault(f => f.IdFiesta == c.IdFiesta);
                var lugar = lugares.FirstOrDefault(l => l.Id == fiesta?.IdLugar);
                var evento = eventos.FirstOrDefault(e => e.Id == fiesta?.IdEvento);

                return new CompraListItem
                    {
                        Vendedor = vendedor?.Nombre ?? "Desconocido",
                        Evento = evento?.Nombre ?? "Desconocido",
                        Lugar = lugar?.Nombre ?? "Desconocido",
                        FechaHora = c.FechaHora,
                        CompraKey = new CompraKeyDTO
                        {
                            IdCliente = id,
                            IdFiesta = c.IdFiesta,
                            FechaHora = c.FechaHora
                        }
                    };
            }).ToList();

            if (comprasParaMostrar.Any())
            {
                selectedCompraKey = comprasParaMostrar[0].CompraKey;
            }
        }
        catch (Exception ex)
        {
            alertCss = "alert-danger";
            alertMessage = $"Error al cargar las compras: {ex.Message}";
        }

        try
        {
            var productos = await ProductoApiClient.GetAllAsync();
            productosParaMostrar = productos.Select(p => new ProdcutoConCantidadDTO
                {
                    Id = p.Id,
                    Descripcion = p.Descripcion,
                    Precio = p.Precio,
                    Cantidad = 0
                }).ToList();
        }
        catch (Exception ex)
        {
            alertCss = "alert-danger";
            alertMessage = $"Error al cargar la lista de productos: {ex.Message}";
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private void SelectCompra(CompraKeyDTO key)
    {
        selectedCompraKey = key;
        alertMessage = null;
    }

    private void OnCantidadChanged(ProdcutoConCantidadDTO producto, string newValue)
    {
        if (int.TryParse(newValue, out int cantidad))
        {
            producto.Cantidad = Math.Max(0, cantidad);
        }
        else
        {
            producto.Cantidad = 0;
        }
    }

    private async Task ComprarAsync()
    {
        alertMessage = null;

        if (!ValidarCompra())
        {
            return;
        }

        isProcessing = true;
        try
        {
            var productosSeleccionados = productosParaMostrar.Where(p => p.Cantidad > 0).ToList();

            var compra = new ProductoConCompraDTO
                {
                    Compra = selectedCompraKey,
                    Producto = productosSeleccionados
                };

            await ProductoApiClient.AddCompra(compra);

            alertCss = "alert-success";
            alertMessage = "Compra realizada con éxito.";
            // refrescar o limpiar cantidades
            foreach (var p in productosParaMostrar) p.Cantidad = 0;
        }
        catch (Exception ex)
        {
            alertCss = "alert-danger";
            alertMessage = $"Error al realizar la compra: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private bool ValidarCompra()
    {
        if (selectedCompraKey == null)
        {
            alertCss = "alert-warning";
            alertMessage = "Por favor, seleccione una compra de la lista.";
            return false;
        }

        var any = productosParaMostrar.Any(p => p.Cantidad > 0);
        if (!any)
        {
            alertCss = "alert-warning";
            alertMessage = "Por favor, seleccione al menos un producto con cantidad mayor a cero.";
            return false;
        }

        return true;
    }

    private void Volver()
    {
        Navigation.NavigateTo("/menucliente");
    }

    private class CompraListItem
    {
        public string Vendedor { get; set; }
        public string Evento { get; set; }
        public string Lugar { get; set; }
        public DateTime FechaHora { get; set; }
        public CompraKeyDTO CompraKey { get; set; }
    }
} 